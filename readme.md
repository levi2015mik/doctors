# Тестовое задание Node.js Backend Developer

Сервис с API для записи человека на прием к врачу. Система работает по принципу REST api. 
Хранилище данных - mongodb.
[Техническое задание](conditions.md)

## Конфигугации

Единственная внешняя зависимость приложения - mongodb. Настройки аутентификации передаются через переменные среды

```
MONGODB_DB_NAME
MONGODB_URI
```
Также они могут быть записаны в файл .env

Настраивается также имя файла логов эмуляции отправки уведомлений и интервал времени проверки для их отправки, но эти параметры имеют значения по умолчанию: messages.json и интервал 10 минут
```
REMIND_TIMEOUT
LOG_FILE_NAME
```
## Запуск и тесты
Сервис весь целиком запускается командой 
`npm start` При первом запуске можно загрузить в базу тестовый набор врачей и пациентов. Это делается командой 

`npm run prefill` Эта команда добавляет нескольких врачей и пациентов, добавляет слоты для записи и записывает пациентов к докторам

Сервис снабжен тестами. Их акоманда - `npm run test` Тесты покрывают практически все запросы rest api и систему отправки уведомлений. 
Недостаток тестов - они не мокают базу данных и пишут непосредственно в нее. **Все данные в базе в процессе тестирования стираются!** 
Нет проверки результатов непосредственно в базе из-за некорректной работы  mongodb в режиме реального времени.
## REST api
### Пользователи 
`get /users` - Получить список пользователей

```
put     /users 
headers: content-type=application/json  
{
	"name":"Boris",
	"phone":"+78652894654"
}
```
Добавление нового пользователя в систему Возвращает вновь созданный объект пользователя.
Если валидатор mongoose возвращает ошибку (не хватает обязательных полей) возврашает 400 ошибку 
```
post    /users/:id
headers: content-type=application/json
{
    Объект пользователя с внесенными правками
}
```
Редактирование объекта пользователя. Если пользователь не найден, возвращает 404
```
delete  /users/:id
```
Удаление пользователя. Если пользователь не найден, возвращает 404. В случае успеха - объект удаленного пользователя

### Доктора
`get /doctors` - Весь доступный список врачей

```
put /doctors
headers: content-type=application/json
{
	"name":"Ivan Ivanov",
	"spec":"Narkolog"
}
```
Добавление нового врача в систему Возвращает вновь созданный объект.
Если валидатор mongoose возвращает ошибку (не хватает обязательных полей) возврашает 400 ошибку 

```
post    /doctors/:id
headers: content-type=application/json
{
    Объект врача с внесенными правками
}
```
Обновление документа путем полного переписывания на новый. При этом моржно исправить или удалить слоты

`delete /doctors/:id` Удаление выбранного доктора

```
put /doctors/:id/slots
headers: content-type=application/json
[
    {"time":"2020-05-16T07:39:53.796Z"},
    {"time":"1589614835630"}
]
```
Открытие слотов для времени приема. В тело запроса передается массив с указанием времени
Время может быть в формате ISO 8601 Extended или в виде числа миллисекунд, с 1 января 1970 года
***Внимание! Нет валидации корректности слотов. Можно открыть два или более слота на одно и то же время***
Возможно, улучшение этого инструментария станет необходимым.
### Запись пациентов
`get /assigns` Получение всей информации о всех слотах вместе с персональными данными пациентов

`get /assigns/all/:id` Получение данных о слотах выбранного врача

`get /assigns/free` Получение всех свободных слотов

`get /assigns/free/:id` Получение свободных слотов заданного врача

`get /assigns/locked` Получение всех уже занятых слотов

`get /assigns/locked/:id` Получение занятых слотов выбранного врача

Все методы get возвращают полный список слотов. Это не правильно. вывод должен быть постраничным и начинаться
с ближайшей даты. Прошлые записи, чтобы сделать их доступными, можно записать как отрицательные страницы 
`get /assigns/locked/:id/:page/:els_on_page` 

```
put /assigns
```
## Эмуляция отправки уведомлений
Отправка уведомлений осушествляется согласно техдаданию дважды - за день и за 2 часа.
За это отвечает модуль `structures/reminder`.
В нем подключается эмулятор отправки. Он обязан иметь единственную функцию `send(message,phone)` Это позволяет быстро подключить нужный метод отправки.

Фунуция эмулятор просто пишет уведомления в файл, а также в общий лог

## Необходимые доработки
Для полноценного использования приложению не хватает системы контроля доступа к api Есть два сценария - регистратура и клиентский доступ.

Регистратура проще и подразумевает просто доступ с api key, ограничиваюшим лимитом в районк нескольких сотен запросов в час 

Регистрация сложнее.
Она должна иметь два уровня 
- клиентский
- административный

Клиентский должен позволять просматривать информацию о врачах, но без доступа к данным других пациентов. Также нужна возможность править информацию о себе.
Этого можно достичь через аутентификацию и добавление временных пользовательских токенов в каждый объект пользователя.
Токен может приходить через cookie. Еще для этого прийдется где то хранить информацию об аутентификации

Клиентский уровень также требуется снабдить ограничением на количество запросов с одного ip
 
 Административное api отвечает за добавление, удаление, редактирование докторов, открытие слотов. Для доступа к нему достаточно иметь секретный api-key и передавать его через http headers
 
 В сегодняшнем варианте нет системы контроля доступа и все запросы могут быть выполнены.